<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi BIIZ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0a0a0a;
            --secondary: #1a1a2e;
            --accent-cyan: #00d4ff;
            --accent-purple: #7c3aed;
            --accent-emerald: #10b981;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
        }
        .orbitron { font-family: 'Orbitron', monospace; }
        .animated-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .particle { position: absolute; width: 2px; height: 2px; background: var(--accent-cyan); border-radius: 50%; animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.5; } 50% { transform: translateY(-20px) rotate(180deg); opacity: 1; } }
        .grid-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(rgba(0, 212, 255, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 212, 255, 0.1) 1px, transparent 1px); background-size: 50px 50px; z-index: -1; animation: gridMove 20s linear infinite; }
        @keyframes gridMove { 0% { transform: translate(0, 0); } 100% { transform: translate(50px, 50px); } }
        .glass-strong { background: rgba(26, 26, 46, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 20px; }
        .neon-text { text-shadow: 0 0 10px var(--accent-cyan), 0 0 20px var(--accent-cyan), 0 0 30px var(--accent-cyan); }
        .neon-button { background: linear-gradient(45deg, var(--accent-cyan), var(--accent-purple)); border: none; color: white; padding: 12px 24px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .neon-button:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 212, 255, 0.4); }
        .neon-button:before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); transition: left 0.5s; }
        .neon-button:hover:before { left: 100%; }
        .futuristic-input { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 8px; padding: 12px 16px; color: white; transition: all 0.3s ease; width: 100%; }
        .futuristic-input:focus { outline: none; border-color: var(--accent-cyan); box-shadow: 0 0 15px rgba(0, 212, 255, 0.3); background: rgba(255, 255, 255, 0.15); }
        .futuristic-input::placeholder { color: var(--text-secondary); }
        .simple-select {
            background-color: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(71, 85, 105, 1);
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.2em 1.2em;
        }
        .simple-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }
        .nav-item { padding: 12px 20px; margin: 4px 0; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; border: 1px solid transparent; }
        .nav-item:hover { background: rgba(0, 212, 255, 0.1); border-color: rgba(0, 212, 255, 0.3); transform: translateX(5px); }
        .nav-item.active { background: linear-gradient(45deg, rgba(0, 212, 255, 0.2), rgba(124, 58, 237, 0.2)); border-color: var(--accent-cyan); }
        .futuristic-card { background: rgba(26, 26, 46, 0.6); backdrop-filter: blur(15px); border: 1px solid rgba(0, 212, 255, 0.2); border-radius: 16px; padding: 24px; transition: all 0.3s ease; }
        .futuristic-card:hover { border-color: var(--accent-cyan); box-shadow: 0 8px 32px rgba(0, 212, 255, 0.2); transform: translateY(-4px); }
        .futuristic-table-wrapper { background: rgba(26, 26, 46, 0.4); backdrop-filter: blur(10px); border-radius: 12px; overflow-x: auto; border: 1px solid rgba(0, 212, 255, 0.2); }
        .futuristic-table { width: 100%; border-collapse: collapse; }
        .futuristic-table th { background: rgba(0, 212, 255, 0.1); padding: 16px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; font-size: 12px; white-space: nowrap; }
        .futuristic-table td { padding: 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .futuristic-table tr:hover { background: rgba(0, 212, 255, 0.05); }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(0, 212, 255, 0.3); border-top: 3px solid var(--accent-cyan); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: var(--accent-cyan); border-radius: 3px; }
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .print-table { width: 100%; border-collapse: collapse; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 8px; text-align: left; color: #000 !important; }
            .print-table th { background-color: #f0f0f0; font-weight: bold; }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="grid-overlay"></div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 flex items-center justify-center z-50 p-4">
        <div class="glass-strong p-8 w-full max-w-md mx-auto fade-in">
            <div class="text-center mb-8">
                <h1 class="orbitron text-3xl font-bold neon-text mb-2">SISTEM</h1>
                <h2 class="orbitron text-xl text-cyan-400">ABSENSI</h2>
                <div class="w-16 h-1 bg-gradient-to-r from-cyan-400 to-purple-500 mx-auto mt-4 rounded"></div>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2 text-cyan-400">Nama Pengguna</label>
                    <input type="text" id="username" class="futuristic-input" placeholder="Masukkan nama pengguna" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2 text-cyan-400">Kata Sandi</label>
                    <input type="password" id="password" class="futuristic-input" placeholder="Masukkan kata sandi" required>
                </div>
                
                <button type="submit" class="neon-button w-full orbitron font-semibold">
                    <span id="loginText">MASUK SISTEM</span>
                    <div id="loginSpinner" class="loading-spinner mx-auto hidden"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed left-0 top-0 h-full w-64 glass-strong z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="p-6">
                <div class="text-center mb-8">
                    <h1 class="orbitron text-xl font-bold neon-text">SISTEM ABSENSI</h1>
                    <p class="text-cyan-400 text-sm">v2.2 (AI Powered)</p>
                </div>
                
                <nav class="space-y-2">
                    <div class="nav-item active" onclick="showSection('dashboard', this)">
                        <span>üè† Dasbor</span>
                    </div>
                    <div class="nav-item" onclick="showSection('classes', this)">
                        <span>üè´ Kelola Kelas</span>
                    </div>
                    <div class="nav-item" onclick="showSection('students', this)">
                        <span>üë• Kelola Siswa</span>
                    </div>
                    <div class="nav-item" onclick="showSection('attendance', this)">
                        <span>üìù Ambil Absensi</span>
                    </div>
                    <div class="nav-item" onclick="showSection('view', this)">
                        <span>üëÅÔ∏è Lihat Absensi</span>
                    </div>
                    <div class="nav-item" onclick="showSection('reports', this)">
                        <span>üìä Buat Laporan</span>
                    </div>
                </nav>
                
                <div class="absolute bottom-6 left-6 right-6">
                    <button onclick="logout()" class="w-full p-3 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                        üö™ Keluar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Sidebar Overlay for Mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden" onclick="toggleSidebar()"></div>

        <!-- Main Content -->
        <main class="md:ml-64 min-h-screen transition-all duration-300 ease-in-out">
            <!-- Header -->
            <header class="glass-strong p-4 m-4 rounded-2xl">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <!-- Hamburger Menu for Mobile -->
                        <button id="menu-toggle" class="md:hidden p-2 rounded-md text-gray-400 hover:text-white hover:bg-white/10" onclick="toggleSidebar()">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        </button>
                        <div>
                            <h2 id="sectionTitle" class="orbitron text-xl md:text-2xl font-bold">Dasbor</h2>
                            <p class="text-gray-400 text-sm hidden sm:block">Selamat datang di Sistem Absensi BIIZ</p>
                            <p class="text-gray-400 text-sm hidden sm:block">Semangat kerjanya yaa... :)</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right hidden sm:block">
                            <p class="text-sm text-gray-400">Tanggal Saat Ini</p>
                            <p id="currentDate" class="font-semibold"></p>
                        </div>
                        <div class="w-12 h-12 bg-gradient-to-r from-cyan-400 to-purple-500 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold">A</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Sections -->
            <div class="p-4">
                <!-- Dashboard Section -->
                <div id="dashboardSection" class="section fade-in">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <!-- Cards here -->
                        <div class="futuristic-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Total Kelas</p>
                                    <p id="totalClasses" class="text-2xl font-bold text-cyan-400">0</p>
                                </div>
                                <div class="text-3xl">üè´</div>
                            </div>
                        </div>
                        <div class="futuristic-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Total Siswa</p>
                                    <p id="totalStudents" class="text-2xl font-bold text-emerald-400">0</p>
                                </div>
                                <div class="text-3xl">üë•</div>
                            </div>
                        </div>
                        <div class="futuristic-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Absensi Hari Ini</p>
                                    <p id="todayAttendance" class="text-2xl font-bold text-purple-400">0</p>
                                </div>
                                <div class="text-3xl">üìù</div>
                            </div>
                        </div>
                        <div class="futuristic-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-400 text-sm">Status Sistem</p>
                                    <p id="systemStatusText" class="text-2xl font-bold text-green-400">Daring</p>
                                </div>
                                <div class="text-3xl">‚ö°</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="futuristic-card">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Aksi Cepat</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                            <button onclick="showSection('attendance', this)" class="neon-button">Ambil Absensi</button>
                            <button onclick="showSection('students', this)" class="neon-button">Tambah Siswa</button>
                            <button onclick="showSection('reports', this)" class="neon-button">Buat Laporan</button>
                        </div>
                    </div>
                </div>


                <!-- Classes Section -->
                <div id="classesSection" class="section hidden">
                    <div class="futuristic-card mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Tambah Kelas Baru</h3>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="inputKelas" placeholder="Masukkan nama kelas (cth: X IPA 1)" class="futuristic-input flex-1">
                            <button onclick="tambahKelas()" class="neon-button">Tambah Kelas</button>
                        </div>
                    </div>
                    
                    <div class="futuristic-card">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Daftar Kelas</h3>
                        <div id="daftarKelas" class="space-y-3"></div>
                    </div>
                </div>

                <!-- Students Section -->
                <div id="studentsSection" class="section hidden">
                    <div class="futuristic-card mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Tambah Siswa Baru</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-cyan-400">Pilih Kelas</label>
                                <select id="selectKelasSiswa" class="simple-select"></select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-cyan-400">Nama Siswa</label>
                                <input type="text" id="inputSiswa" placeholder="Masukkan nama siswa" class="futuristic-input">
                            </div>
                        </div>
                        <button onclick="tambahSiswa()" class="neon-button">Tambah Siswa</button>
                    </div>
                    
                    <div class="futuristic-card">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Daftar Siswa</h3>
                        <div id="daftarSiswa" class="space-y-4"></div>
                    </div>
                </div>

                <!-- Attendance Section -->
                <div id="attendanceSection" class="section hidden">
                    <div class="futuristic-card mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Ambil Absensi Harian</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-cyan-400">Pilih Kelas</label>
                                <select id="selectKelasIsiAbsensi" onchange="tampilkanSiswaUntukAbsensi()" class="simple-select"></select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-cyan-400">Tanggal</label>
                                <p id="tanggalHariIni" class="text-lg font-semibold text-white p-3 bg-white/5 rounded-lg"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="futuristic-card">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Absensi Siswa</h3>
                        <div class="futuristic-table-wrapper">
                            <table class="futuristic-table">
                                <thead>
                                    <tr>
                                        <th class="text-left">No</th>
                                        <th class="text-left">Nama Siswa</th>
                                        <th class="text-left">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelAbsensiSiswa"></tbody>
                            </table>
                        </div>
                        <button onclick="simpanAbsensi()" class="neon-button mt-4">Simpan Absensi</button>
                    </div>
                </div>

                <!-- View Attendance Section -->
                <div id="viewSection" class="section hidden">
                    <div class="futuristic-card mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Lihat & Ubah Absensi</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-cyan-400">Pilih Kelas</label>
                                <select id="selectKelasLihat" class="simple-select"></select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-cyan-400">Pilih Tanggal</label>
                                <input type="date" id="inputTanggalLihat" class="futuristic-input">
                            </div>
                            <div class="flex items-end">
                                <button onclick="tampilkanAbsensiTersimpan()" class="neon-button w-full">Lihat Absensi</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="futuristic-card">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Catatan Absensi</h3>
                        <div class="futuristic-table-wrapper">
                            <table class="futuristic-table">
                                <thead>
                                    <tr>
                                        <th class="text-left">No</th>
                                        <th class="text-left">Nama Siswa</th>
                                        <th class="text-left">Status</th>
                                        <th class="text-left">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelLihatAbsensi">
                                    <tr>
                                        <td colspan="4" class="text-center text-gray-400 py-8">Pilih kelas dan tanggal untuk melihat data absensi</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reportsSection" class="section hidden">
                    <div class="futuristic-card mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Jenis Laporan</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <!-- Report type radios -->
                            <label class="flex items-center space-x-2 cursor-pointer p-3 rounded-lg border border-cyan-400/30 hover:bg-cyan-400/10 transition-colors">
                                <input type="radio" name="reportType" value="daily" onchange="showReportForm()" class="text-cyan-400 focus:ring-cyan-500">
                                <span>Harian</span>
                            </label>
                             <label class="flex items-center space-x-2 cursor-pointer p-3 rounded-lg border border-cyan-400/30 hover:bg-cyan-400/10 transition-colors">
                                <input type="radio" name="reportType" value="weekly" onchange="showReportForm()" class="text-cyan-400 focus:ring-cyan-500">
                                <span>Mingguan</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer p-3 rounded-lg border border-cyan-400/30 hover:bg-cyan-400/10 transition-colors">
                                <input type="radio" name="reportType" value="monthly" onchange="showReportForm()" class="text-cyan-400 focus:ring-cyan-500">
                                <span>Bulanan</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer p-3 rounded-lg border border-cyan-400/30 hover:bg-cyan-400/10 transition-colors">
                                <input type="radio" name="reportType" value="semester" onchange="showReportForm()" class="text-cyan-400 focus:ring-cyan-500" checked>
                                <span>Semester</span>
                            </label>
                        </div>

                        <!-- Dynamic Report Forms -->
                        <div id="reportForms">
                            <!-- Daily Report Form -->
                            <div id="dailyForm" class="report-form hidden grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-cyan-400/10 rounded-lg">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-cyan-400">Pilih Kelas</label>
                                    <select id="selectKelasDailyLaporan" class="simple-select"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-cyan-400">Pilih Tanggal</label>
                                    <input type="date" id="inputTanggalDaily" class="futuristic-input">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="generateDailyReport()" class="neon-button w-full">Buat Laporan Harian</button>
                                </div>
                            </div>

                            <!-- Weekly Report Form -->
                            <div id="weeklyForm" class="report-form hidden grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-emerald-400/10 rounded-lg">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-cyan-400">Pilih Kelas</label>
                                    <select id="selectKelasWeeklyLaporan" class="simple-select"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-cyan-400">Tanggal Mulai Minggu</label>
                                    <input type="date" id="inputTanggalWeekly" class="futuristic-input">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="generateWeeklyReport()" class="neon-button w-full">Buat Laporan Mingguan</button>
                                </div>
                            </div>

                            <!-- Monthly Report Form -->
                            <div id="monthlyForm" class="report-form hidden grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-purple-400/10 rounded-lg">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-cyan-400">Pilih Kelas</label>
                                    <select id="selectKelasMonthlyLaporan" class="simple-select"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-cyan-400">Pilih Bulan/Tahun</label>
                                    <input type="month" id="inputBulanTahun" class="futuristic-input">
                                </div>
                                <div class="flex items-end">
                                    <button onclick="generateMonthlyReport()" class="neon-button w-full">Buat Laporan Bulanan</button>
                                </div>
                            </div>

                            <!-- Semester Report Form -->
                            <div id="semesterForm" class="report-form grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-indigo-400/10 rounded-lg">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-cyan-400">Pilih Kelas</label>
                                    <select id="selectKelasSemesterLaporan" class="simple-select"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-cyan-400">Pilih Semester</label>
                                    <select id="selectSemesterLaporan" class="simple-select">
                                        <option value="ganjil">Semester Ganjil (Juli - Desember)</option>
                                        <option value="genap">Semester Genap (Januari - Juni)</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="generateSemesterReport()" class="neon-button w-full">Buat Laporan Semester</button>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-4 mt-6 no-print">
                            <button onclick="cetakLaporanExcel()" class="neon-button">Ekspor ke Excel</button>
                            <button onclick="window.print()" class="neon-button">Cetak PDF</button>
                            <!-- Gemini AI Button -->
                            <button id="geminiAnalyzeBtn" onclick="analyzeReportWithGemini()" class="neon-button hidden">‚ú® Analisis Laporan dengan AI</button>
                        </div>
                    </div>

                    <!-- Report Display Area -->
                    <div class="futuristic-card print-area">
                        <div id="reportHeader" class="mb-6"></div>
                        <div id="reportContent"></div>
                    </div>
                    
                    <!-- Gemini AI Analysis Result Area -->
                    <div id="geminiAnalysisResult" class="futuristic-card mt-6 hidden no-print"></div>

                </div>
            </div>
        </main>
    </div>

    <script>
        // --- RESPONSIVE UI SCRIPT ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        // --- CORE APPLICATION SCRIPT ---

        // =========================================================================
        // SPREADSHEET & GEMINI API CONFIGURATION
        // =========================================================================
        // PASTE YOUR GOOGLE APPS SCRIPT DEPLOYMENT URL HERE
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwMuO8wzsutE2OnKA_cdfzPr3bl6g9MuwCOlR4BevJThT_auXZn1Rw1FzzVIT9x1jJZ/exec"; 

        // Global state to cache data and reduce API calls
        let appState = {
            classes: [],
            students: {}, // { className: [student1, student2] }
            attendance: {} // { 'className-date': [record1, record2] }
        };

        /**
         * Generic function to fetch data from Google Apps Script (GET requests)
         * @param {string} action - The action to perform (e.g., 'readClasses').
         * @param {object} params - An object of URL parameters.
         * @returns {Promise<any>} - The data from the server.
         */
        async function fetchData(action, params = {}) {
            const url = new URL(SCRIPT_URL);
            url.searchParams.append('action', action);
            for (const key in params) {
                if (params[key]) url.searchParams.append(key, params[key]);
            }
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.status === 'error') throw new Error(result.message);
                return result.data;
            } catch (error) {
                console.error(`Error fetching ${action}:`, error);
                alert(`Gagal mengambil data: ${error.message}. Pastikan URL SCRIPT_URL sudah benar dan server terhubung.`);
                return null;
            }
        }

        /**
         * Generic function to post data to Google Apps Script (POST requests)
         * @param {object} body - The data to send in the request body.
         * @returns {Promise<any>} - The response from the server.
         */
       async function postData(body) {
    try {
        const formData = new FormData();
        for (const key in body) {
            formData.append(key, typeof body[key] === 'object' ? JSON.stringify(body[key]) : body[key]);
        }
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.status === 'error') throw new Error(result.message);
        return result;
    } catch (error) {
        console.error('Error posting data:', error);
        alert(`Gagal mengirim data: ${error.message}. Pastikan URL SCRIPT_URL sudah benar.`);
        return null;
    }
}


        // Initialize particles
        function createParticles() {
            const bg = document.querySelector('.animated-bg');
            if (bg.children.length > 0) return; // Don't create duplicates
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                bg.appendChild(particle);
            }
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const loginText = document.getElementById('loginText');
            const loginSpinner = document.getElementById('loginSpinner');
            
            loginText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');
            
            setTimeout(() => {
                if (username === 'iyeyy' && password === 'iyeyyatuu') {
                    if (SCRIPT_URL === "https://script.google.com/macros/s/AKfycbwMuO8wzsutE2OnKA_cdfzPr3bl6g9MuwCOlR4BevJThT_auXZn1Rw1FzzVIT9x1jJZ/exec") {
                        alert("Login berhasil, tetapi Anda belum memasukkan URL Google Apps Script. Silakan ikuti petunjuk untuk menghubungkan ke spreadsheet.");
                    }
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    initializeApp();
                } else {
                    alert('Kredensial tidak valid!');
                    loginText.classList.remove('hidden');
                    loginSpinner.classList.add('hidden');
                }
            }, 1500);
        });

        // Logout functionality
        function logout() {
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            appState = { classes: [], students: {}, attendance: {} };
        }

        // Initialize application
        async function initializeApp() {
            updateCurrentDate();
            setTanggalHariIni();
            document.getElementById('inputTanggalLihat').value = getTanggalHariIniISO();
            document.getElementById('inputTanggalDaily').value = getTanggalHariIniISO();
            document.getElementById('inputTanggalWeekly').value = getTanggalHariIniISO();
            document.getElementById('inputBulanTahun').value = getCurrentMonthYear();
            showReportForm();
            
            await updateDashboard(); 
            await renderSemua();
        }

        // Update current date
        function updateCurrentDate() {
            const now = new Date();
            const dateElem = document.getElementById('currentDate');
            if(dateElem) {
                dateElem.textContent = now.toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }

        // Update dashboard stats and system status
        async function updateDashboard() {
            const statusTextElem = document.getElementById('systemStatusText');
            const result = await fetchData('readDashboardData');
            
            if (result) {
                document.getElementById('totalClasses').textContent = result.totalClasses || 0;
                document.getElementById('totalStudents').textContent = result.totalStudents || 0;
                document.getElementById('todayAttendance').textContent = result.totalAttendanceToday || 0;
                statusTextElem.textContent = 'Daring';
                statusTextElem.classList.remove('text-red-400');
                statusTextElem.classList.add('text-green-400');
            } else {
                document.getElementById('totalClasses').textContent = '-';
                document.getElementById('totalStudents').textContent = '-';
                document.getElementById('todayAttendance').textContent = '-';
                statusTextElem.textContent = 'Luring';
                statusTextElem.classList.remove('text-green-400');
                statusTextElem.classList.add('text-red-400');
            }
        }

        // Section navigation
        function showSection(sectionName, navElement) {
            document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            if (navElement) {
                const navItem = navElement.closest('.nav-item') || document.querySelector(`.nav-item[onclick*="'${sectionName}'"]`);
                if (navItem) navItem.classList.add('active');
            }
            
            const titles = {
                dashboard: 'Dasbor', classes: 'Kelola Kelas', students: 'Kelola Siswa',
                attendance: 'Ambil Absensi', view: 'Lihat Absensi', reports: 'Buat Laporan'
            };
            document.getElementById('sectionTitle').textContent = titles[sectionName];
            
            if (['students', 'attendance', 'view', 'reports'].includes(sectionName)) {
                updatePilihanKelas();
            }
            if (sectionName === 'attendance') {
                tampilkanSiswaUntukAbsensi();
            }
            
            if (window.innerWidth < 768) toggleSidebar();
        }

        // Render all data
        async function renderSemua() {
            await renderDaftarKelas();
            await renderDaftarSiswa();
            updatePilihanKelas();
        }

        // Class management functions
        async function tambahKelas() {
            const input = document.getElementById('inputKelas');
            const nama = input.value.trim();
            if (nama) {
                const result = await postData({ action: 'tambahKelas', NamaKelas: nama });
                if (result) {
                    input.value = '';
                    appState.classes = []; // Clear cache to force reload
                    await renderSemua();
                    await updateDashboard();
                }
            } else {
                alert('Nama kelas tidak boleh kosong!');
            }
        }

        async function renderDaftarKelas() {
            const container = document.getElementById('daftarKelas');
            container.innerHTML = '<div class="loading-spinner mx-auto"></div>';
            const data = await fetchData('readClasses');
            appState.classes = data || [];
            if (!appState.classes.length) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada kelas.</p>';
                return;
            }
            container.innerHTML = appState.classes.map(k => `
                <div class="flex flex-col sm:flex-row justify-between items-center p-4 bg-white/5 rounded-lg border border-cyan-400/20 hover:border-cyan-400/50 transition-colors gap-2">
                    <span class="text-white font-medium">${k}</span>
                    <div class="space-x-2 flex-shrink-0">
                        <button onclick="hapusKelas('${k}')" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition-colors">Hapus</button>
                    </div>
                </div>
            `).join('');
        }

        async function hapusKelas(NamaKelas) {
            if (confirm(`Apakah Anda yakin ingin menghapus kelas "${NamaKelas}"? Ini akan menghapus semua siswa dan catatan absensi di dalamnya.`)) {
                const result = await postData({ action: 'hapusKelas', NamaKelas });
                if(result) {
                    appState = { classes: [], students: {}, attendance: {} }; // Reset state
                    await renderSemua();
                    await updateDashboard();
                }
            }
        }
        
        // Student management functions
        async function tambahSiswa() {
            const kelas = document.getElementById('selectKelasSiswa').value;
            const input = document.getElementById('inputSiswa');
            const nama = input.value.trim();
            if (nama && kelas && !kelas.startsWith('Buat kelas')) {
                const result = await postData({ action: 'tambahSiswa', NamaKelas: kelas, NamaSiswa: nama });
                if (result) {
                    input.value = '';
                    delete appState.students[kelas]; // Invalidate cache for this class
                    await renderDaftarSiswa();
                    await updateDashboard();
                }
            } else {
                alert('Silakan pilih kelas dan masukkan nama siswa.');
            }
        }

        async function renderDaftarSiswa() {
            const container = document.getElementById('daftarSiswa');
            container.innerHTML = '<div class="loading-spinner mx-auto"></div>';
            appState.students = {};
            for (const kelas of appState.classes) {
                const siswa = await fetchData('readStudents', { NamaKelas: kelas });
                appState.students[kelas] = siswa || [];
            }

            if (Object.keys(appState.students).length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">Belum ada siswa.</p>';
                return;
            }

            container.innerHTML = Object.entries(appState.students).map(([kelas, siswas]) => `
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-cyan-400 mb-3">${kelas}</h4>
                    <div class="space-y-2">
                        ${siswas.map((s, idx) => `
                            <div class="flex flex-col sm:flex-row justify-between items-center p-3 bg-white/5 rounded-lg border border-cyan-400/20 hover:border-cyan-400/50 transition-colors gap-2">
                                <span class="text-white"><span class="font-bold mr-2">${idx + 1}.</span>${s.NamaSiswa}</span>
                                <div class="space-x-2 flex-shrink-0">
                                    <button onclick="hapusSiswa('${s.ID}', '${s.NamaKelas}')" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition-colors">Hapus</button>
                                </div>
                            </div>
                        `).join('') || '<p class="text-gray-500 italic px-3">Tidak ada siswa di kelas ini.</p>'}
                    </div>
                </div>
            `).join('');
        }

        async function hapusSiswa(siswaID, kelas) {
            if (confirm(`Apakah Anda yakin ingin menghapus siswa ini? Ini akan menghapus riwayat absensinya.`)) {
                const result = await postData({ action: 'hapusSiswa', siswaID: siswaID });
                if(result) {
                    delete appState.students[kelas]; // Invalidate cache
                    await renderDaftarSiswa();
                    await updateDashboard();
                }
            }
        }

        // Dropdown and date management
        function updatePilihanKelas() {
            const data = appState.classes;
            const selects = [
                'selectKelasSiswa', 'selectKelasIsiAbsensi', 'selectKelasLihat',
                'selectKelasDailyLaporan', 'selectKelasWeeklyLaporan', 'selectKelasMonthlyLaporan', 'selectKelasSemesterLaporan'
            ];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '';
                    if (data.length === 0) {
                        select.innerHTML = '<option>Buat kelas terlebih dahulu</option>';
                    } else {
                        select.innerHTML = data.map(k => `<option value="${k}" ${k === currentValue ? 'selected' : ''}>${k}</option>`).join('');
                    }
                }
            });
        }

        function getTanggalHariIniISO() { return new Date().toISOString().split('T')[0]; }
        function getCurrentMonthYear() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }
        function setTanggalHariIni() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('tanggalHariIni').innerText = new Date().toLocaleDateString('id-ID', options);
        }

        // Attendance management
        async function tampilkanSiswaUntukAbsensi() {
            const kelas = document.getElementById('selectKelasIsiAbsensi').value;
            const tbody = document.getElementById('tabelAbsensiSiswa');
            tbody.innerHTML = '';
            if (!kelas || kelas.startsWith('Buat kelas')) return;

            // Use cached students if available
            let siswa = appState.students[kelas];
            if (!siswa) {
                tbody.innerHTML = '<tr><td colspan="3"><div class="loading-spinner mx-auto"></div></td></tr>';
                const result = await fetchData('readStudents', { NamaKelas: kelas });
                siswa = result || [];
                appState.students[kelas] = siswa; // Cache the result
            }

            if (siswa.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400 py-8">Tidak ada siswa di kelas ini.</td></tr>';
                return;
            }
            tbody.innerHTML = siswa.map((s, idx) => `
                <tr class="hover:bg-cyan-400/5 transition-colors">
                    <td class="py-3 px-4 font-bold">${idx + 1}.</td>
                    <td class="py-3 px-4">${s.NamaSiswa}</td>
                    <td class="py-3 px-4">
                        <select class="simple-select" data-siswa-id="${s.ID}" data-nama-siswa="${s.NamaSiswa}">
                            <option value="Hadir">Hadir</option>
                            <option value="Sakit">Sakit</option>
                            <option value="Izin">Izin</option>
                            <option value="Alfa">Alfa</option>
                        </select>
                    </td>
                </tr>`).join('');
        }

        async function simpanAbsensi() {
            const kelas = document.getElementById('selectKelasIsiAbsensi').value;
            const tanggal = getTanggalHariIniISO();
            const selects = document.querySelectorAll('#tabelAbsensiSiswa select');
            
            if (selects.length === 0) { alert('Tidak ada siswa untuk dicatat absensinya.'); return; }

            const absensiBaru = Array.from(selects).map(s => ({ 
                ID: s.dataset.siswaId,
                NamaSiswa: s.dataset.namaSiswa,
                NamaKelas: kelas, 
                Tanggal: tanggal,
                Status: s.value 
            }));

            const result = await postData({ action: 'simpanAbsensi', absensiData: absensiBaru });
            if (result) {
                alert(`Absensi untuk kelas ${kelas} pada tanggal ${tanggal} berhasil dikirim untuk disimpan!`);
                delete appState.attendance[`${kelas}-${tanggal}`]; // Invalidate cache
                await updateDashboard();
            }
        }

        // View attendance management
        async function tampilkanAbsensiTersimpan() {
            const kelas = document.getElementById('selectKelasLihat').value;
            const tanggal = document.getElementById('inputTanggalLihat').value;
            const tbody = document.getElementById('tabelLihatAbsensi');
            if (!tanggal) { alert("Silakan pilih tanggal terlebih dahulu."); return; }
            if (!kelas || kelas.startsWith('Buat kelas')) { alert("Silakan pilih kelas terlebih dahulu."); return; }
            
            tbody.innerHTML = '<tr><td colspan="4"><div class="loading-spinner mx-auto"></div></td></tr>';
            
            const cacheKey = `${kelas}-${tanggal}`;
            let dataTampil;

            // Check cache first
            if (!appState.attendance[cacheKey]) {
                const result = await fetchData('readAttendance', { NamaKelas: kelas, tanggal: tanggal });
                appState.attendance[cacheKey] = result || [];
            }
            dataTampil = appState.attendance[cacheKey];

            if (dataTampil.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-400 py-8">Tidak ada data absensi untuk kelas dan tanggal ini.</td></tr>`;
                return;
            }

            tbody.innerHTML = dataTampil.map((data, idx) => `
                <tr class="hover:bg-cyan-400/5 transition-colors">
                    <td class="py-3 px-4 font-bold">${idx + 1}.</td>
                    <td class="py-3 px-4 font-medium">${data.NamaSiswa}</td>
                    <td class="py-3 px-4">${data.Status}</td>
                    <td class="py-3 px-4">
                        <button onclick="editAbsensi('${data.ID}', '${data.NamaKelas}', '${data.Tanggal}', '${data.Status}')" class="px-3 py-1 bg-yellow-600 hover:bg-yellow-700 rounded text-sm transition-colors">Ubah</button>
                    </td>
                </tr>
            `).join('');
        }

        async function editAbsensi(absensiID, NamaKelas, Tanggal, StatusLama) {
            const statusList = ['Hadir', 'Sakit', 'Izin', 'Alfa'];
            const statusBaru = prompt(`Masukkan status baru untuk absensi tanggal ${Tanggal} (Hadir, Sakit, Izin, Alfa):`, StatusLama);
            
            if (statusBaru && statusList.map(s => s.toLowerCase()).includes(statusBaru.toLowerCase())) {
                const statusBaruFormatted = statusBaru.charAt(0).toUpperCase() + statusBaru.slice(1).toLowerCase();
                const result = await postData({ action: 'updateStatusAbsensi', absensiID: absensiID, tanggal: Tanggal, status: statusBaruFormatted });
                if (result) {
                    alert(`Status absensi berhasil diubah menjadi ${statusBaruFormatted}.`);
                    delete appState.attendance[`${NamaKelas}-${Tanggal}`]; // Invalidate cache
                    await tampilkanAbsensiTersimpan();
                }
            } else if (statusBaru !== null) {
                alert('Status tidak valid! Silakan masukkan: Hadir, Sakit, Izin, atau Alfa.');
            }
        }

        // Report management functions
        function showReportForm() {
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            document.querySelectorAll('.report-form').forEach(form => form.classList.add('hidden'));
            document.getElementById(reportType + 'Form').classList.remove('hidden');
            
            document.getElementById('geminiAnalyzeBtn').classList.add('hidden');
            document.getElementById('geminiAnalysisResult').classList.add('hidden');
            document.getElementById('reportContent').innerHTML = '';
            document.getElementById('reportHeader').innerHTML = '';
        }

        async function generateReport(reportType, elementIds) {
            const kelas = document.getElementById(elementIds.selectKelas).value;
            if (!kelas || kelas.startsWith('Buat kelas')) { alert("Pilih kelas yang valid."); return; }
            
            const geminiBtn = document.getElementById('geminiAnalyzeBtn');
            const geminiResult = document.getElementById('geminiAnalysisResult');
            geminiBtn.classList.add('hidden');
            geminiResult.classList.add('hidden');
            
            let startDate, endDate;
            const reportHeaderElem = document.getElementById('reportHeader');
            const reportContentElem = document.getElementById('reportContent');
            reportHeaderElem.innerHTML = '';
            reportContentElem.innerHTML = '<div class="loading-spinner mx-auto my-8"></div>';
            
            const year = new Date().getFullYear();
            let periodText = '';
            
            switch(reportType) {
                case 'daily':
                    startDate = endDate = document.getElementById(elementIds.inputTanggal).value;
                    if (!startDate) { alert("Pilih tanggal yang valid."); reportContentElem.innerHTML = ''; return; }
                    periodText = `Tanggal: ${new Date(startDate + 'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
                    break;
                case 'weekly':
                    const startOfWeek = new Date(document.getElementById(elementIds.inputTanggal).value + 'T00:00:00');
                    if (isNaN(startOfWeek.getTime())) { alert("Pilih tanggal mulai minggu yang valid."); reportContentElem.innerHTML = ''; return; }
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    startDate = startOfWeek.toISOString().split('T')[0];
                    endDate = endOfWeek.toISOString().split('T')[0];
                    periodText = `Periode: ${startOfWeek.toLocaleDateString('id-ID')} - ${endOfWeek.toLocaleDateString('id-ID')}`;
                    break;
                case 'monthly':
                    const monthYear = document.getElementById(elementIds.inputBulanTahun).value;
                    if (!monthYear) { alert("Pilih bulan/tahun yang valid."); reportContentElem.innerHTML = ''; return; }
                    const [mYear, mMonth] = monthYear.split('-');
                    startDate = `${monthYear}-01`;
                    const lastDay = new Date(mYear, mMonth, 0).getDate();
                    endDate = `${monthYear}-${String(lastDay).padStart(2, '0')}`;
                    periodText = `Bulan: ${new Date(mYear, mMonth - 1).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}`;
                    break;
                case 'semester':
                    const semester = document.getElementById(elementIds.selectSemester).value;
                    const semesterMonths = semester === 'ganjil' ? {start: `${year}-07-01`, end: `${year}-12-31`} : {start: `${year}-01-01`, end: `${year}-06-30`};
                    startDate = semesterMonths.start;
                    endDate = semesterMonths.end;
                    periodText = `Semester: ${semester === 'ganjil' ? 'Ganjil' : 'Genap'} ${year}`;
                    break;
            }
            
            const reportData = await fetchData('readReportData', { reportType, NamaKelas: kelas, startDate, endDate });

            if (!reportData) {
                reportContentElem.innerHTML = '<p class="text-center text-gray-400 py-8">Gagal memuat data laporan.</p>';
                return;
            }
            if (reportData.length === 0) {
                reportContentElem.innerHTML = '<p class="text-center text-gray-400 py-8">Tidak ada data absensi pada periode ini.</p>';
                return;
            }

            const reportName = `LAPORAN ABSENSI ${reportType.toUpperCase()}`;
            const header = `<div class="text-center mb-6"><h3 class="orbitron text-2xl font-bold text-cyan-400 mb-2">${reportName}</h3><p class="text-lg text-white">Kelas: ${kelas}</p><p class="text-lg text-white">${periodText}</p><div class="w-24 h-1 bg-gradient-to-r from-cyan-400 to-purple-500 mx-auto mt-4 rounded"></div></div>`;
            
            let tableContent = '';
            let summary = '';
            
            if (reportType === 'daily') {
                tableContent = createDailyTable(reportData);
            } else if (reportType === 'weekly' || reportType === 'monthly') {
                tableContent = createWeeklyMonthlyTable(reportData, startDate, endDate);
                summary = createWeeklyMonthlySummary(reportData);
            } else { // Semester
                tableContent = createSemesterTable(reportData);
                summary = createSummary(reportData.reduce((acc, curr) => {
                    acc.Hadir += curr.hadir;
                    acc.Sakit += curr.sakit;
                    acc.Izin += curr.izin;
                    acc.Alfa += curr.alfa;
                    return acc;
                }, { Hadir: 0, Sakit: 0, Izin: 0, Alfa: 0 }));
            }
            
            reportHeaderElem.innerHTML = header;
            reportContentElem.innerHTML = tableContent + summary;
            geminiBtn.classList.remove('hidden');
        }

        function createDailyTable(data) {
            return `<div class="futuristic-table-wrapper">
                <table class="print-table futuristic-table min-w-[400px]">
                    <thead><tr><th>No</th><th>Nama Siswa</th><th>Keterangan</th></tr></thead>
                    <tbody>
                        ${data.map((row, i) => `<tr><td>${i + 1}</td><td>${row.NamaSiswa}</td><td>${row.status}</td></tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
        }

        function createWeeklyMonthlyTable(data, startDate, endDate) {
            const dates = [];
            let current = new Date(startDate + 'T00:00:00');
            const last = new Date(endDate + 'T00:00:00');
            while (current <= last) {
                dates.push(current.toISOString().split('T')[0]);
                current.setDate(current.getDate() + 1);
            }
            let table = `<div class="futuristic-table-wrapper"><table class="print-table futuristic-table min-w-[800px]"><thead><tr><th>No</th><th>Nama Siswa</th>`;
            dates.forEach(d => { table += `<th class="text-center">${new Date(d + 'T00:00:00').getDate()}</th>`; });
            table += `<th class="text-center">Hadir</th><th class="text-center">Alfa</th><th class="text-center">Izin</th><th class="text-center">Sakit</th></tr></thead><tbody>`;
            data.forEach((row, i) => {
                let hadir = 0, alfa = 0, izin = 0, sakit = 0;
                table += `<tr><td>${i + 1}</td><td>${row.NamaSiswa}</td>`;
                dates.forEach(d => {
                    let status = row.absensi[d] ? row.absensi[d] : '-';
                    table += `<td class="text-center">${status.charAt(0)}</td>`;
                    if (status === 'Hadir') hadir++;
                    else if (status === 'Alfa') alfa++;
                    else if (status === 'Izin') izin++;
                    else if (status === 'Sakit') sakit++;
                });
                table += `<td class="text-center">${hadir}</td><td class="text-center">${alfa}</td><td class="text-center">${izin}</td><td class="text-center">${sakit}</td></tr>`;
            });
            table += `</tbody></table></div>`;
            return table;
        }
        
        function createSemesterTable(data) {
            return `<div class="futuristic-table-wrapper"><table class="print-table futuristic-table min-w-[800px]"><thead><tr><th class="text-left">No</th><th class="text-left">Nama Siswa</th><th class="text-center">Hadir</th><th class="text-center">Sakit</th><th class="text-center">Izin</th><th class="text-center">Alfa</th><th class="text-center">Total Hari</th></tr></thead><tbody>
                ${data.map((siswa, index) => `<tr><td>${index + 1}</td><td>${siswa.NamaSiswa}</td><td class="text-center">${siswa.hadir}</td><td class="text-center">${siswa.sakit}</td><td class="text-center">${siswa.izin}</td><td class="text-center">${siswa.alfa}</td><td class="text-center">${siswa.total}</td></tr>`).join('')}
            </tbody></table></div>`;
        }

        function createWeeklyMonthlySummary(data) {
            let total = { Hadir: 0, Alfa: 0, Izin: 0, Sakit: 0 };
            data.forEach(row => {
                Object.values(row.absensi || {}).forEach(status => {
                    if (status === 'Hadir') total.Hadir++;
                    else if (status === 'Alfa') total.Alfa++;
                    else if (status === 'Izin') total.Izin++;
                    else if (status === 'Sakit') total.Sakit++;
                });
            });
            return createSummary(total);
        }

        function generateDailyReport() { generateReport('daily', { selectKelas: 'selectKelasDailyLaporan', inputTanggal: 'inputTanggalDaily' }); }
        function generateWeeklyReport() { generateReport('weekly', { selectKelas: 'selectKelasWeeklyLaporan', inputTanggal: 'inputTanggalWeekly' }); }
        function generateMonthlyReport() { generateReport('monthly', { selectKelas: 'selectKelasMonthlyLaporan', inputBulanTahun: 'inputBulanTahun' }); }
        function generateSemesterReport() { generateReport('semester', { selectKelas: 'selectKelasSemesterLaporan', selectSemester: 'selectSemesterLaporan' }); }

        function createSummary(summaryData) {
            const total = (summaryData.Hadir || 0) + (summaryData.Sakit || 0) + (summaryData.Izin || 0) + (summaryData.Alfa || 0);
            return `<div class="mt-6 p-6 bg-gradient-to-r from-cyan-400/10 to-purple-500/10 rounded-lg border border-cyan-400/30"><h4 class="text-lg font-semibold mb-4 text-cyan-400 orbitron">RINGKASAN KEHADIRAN</h4><div class="grid grid-cols-2 sm:grid-cols-5 gap-4"><div class="text-center p-4 bg-green-500/20 rounded-lg border border-green-500/30"><div class="text-3xl font-bold text-green-400 orbitron">${summaryData.Hadir || 0}</div><div class="text-sm text-gray-300">Hadir</div></div><div class="text-center p-4 bg-yellow-500/20 rounded-lg border border-yellow-500/30"><div class="text-3xl font-bold text-yellow-400 orbitron">${summaryData.Sakit || 0}</div><div class="text-sm text-gray-300">Sakit</div></div><div class="text-center p-4 bg-blue-500/20 rounded-lg border border-blue-500/30"><div class="text-3xl font-bold text-blue-400 orbitron">${summaryData.Izin || 0}</div><div class="text-sm text-gray-300">Izin</div></div><div class="text-center p-4 bg-red-500/20 rounded-lg border border-red-500/30"><div class="text-3xl font-bold text-red-400 orbitron">${summaryData.Alfa || 0}</div><div class="text-sm text-gray-300">Alfa</div></div><div class="col-span-2 sm:col-span-1 text-center p-4 bg-gray-500/20 rounded-lg border border-gray-500/30"><div class="text-3xl font-bold text-gray-300 orbitron">${total}</div><div class="text-sm text-gray-300">Total</div></div></div></div>`;
        }

        function cetakLaporanExcel() {
            const reportContent = document.getElementById('reportContent');
            if (!reportContent.innerHTML.trim() || reportContent.querySelector('.loading-spinner')) {
                alert('Tidak ada data laporan untuk diekspor atau data sedang dimuat.');
                return;
            }
            const table = reportContent.querySelector('table');
            if (!table) {
                alert('Tidak ada tabel di dalam laporan untuk diekspor.');
                return;
            }

            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            const kelasSelectId = `selectKelas${reportType.charAt(0).toUpperCase() + reportType.slice(1)}Laporan`;
            const kelasSelect = document.getElementById(kelasSelectId);
            const kelas = kelasSelect ? kelasSelect.value : 'laporan';
            const timestamp = getTanggalHariIniISO();
            const fileName = `Laporan_Absensi_${reportType}_${kelas}_${timestamp}.xlsx`;

            const wb = XLSX.utils.table_to_book(table, { sheet: "Laporan Absensi" });
            XLSX.writeFile(wb, fileName);
        }
        
        // =========================================================================
        // GEMINI AI INTEGRATION
        // =========================================================================
        async function analyzeReportWithGemini() {
            const reportHeaderElem = document.getElementById('reportHeader');
            const reportContentElem = document.getElementById('reportContent');
            const analysisResultElem = document.getElementById('geminiAnalysisResult');

            if (!reportHeaderElem.innerText || !reportContentElem.querySelector('table')) {
                alert('Silakan buat laporan terlebih dahulu sebelum menganalisis.');
                return;
            }

            analysisResultElem.classList.remove('hidden');
            analysisResultElem.innerHTML = `<div class="flex items-center gap-4"><div class="loading-spinner"></div><p class="text-lg text-cyan-400">AI sedang menganalisis laporan, mohon tunggu...</p></div>`;

            const reportTitle = reportHeaderElem.querySelector('h3').innerText;
            const reportDetails = Array.from(reportHeaderElem.querySelectorAll('p')).map(p => p.innerText).join('\n');
            const tableRows = Array.from(reportContentElem.querySelectorAll('tr'));
            const reportData = tableRows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => cell.innerText).join('\t|\t');
            }).join('\n');
            
            const prompt = `
                Anda adalah asisten guru yang ahli dalam menganalisis data absensi siswa.
                Tugas Anda adalah memberikan analisis singkat, padat, dan bermanfaat dari data laporan berikut.

                **Data Laporan:**
                Judul: ${reportTitle}
                Detail: ${reportDetails}
                Tabel Data:
                ${reportData}

                **Instruksi Analisis:**
                1.  **Ringkasan Umum:** Berikan ringkasan singkat tentang tingkat kehadiran secara keseluruhan (misalnya: "Kehadiran secara umum baik", "Perlu perhatian pada beberapa siswa").
                2.  **Siswa yang Perlu Diperhatikan:** Identifikasi siswa dengan jumlah 'Alfa' atau 'Sakit' yang tinggi. Sebutkan nama mereka dan jumlah ketidakhadirannya.
                3.  **Tren Positif (jika ada):** Sebutkan siswa yang memiliki kehadiran 100% (tidak ada Alfa, Sakit, atau Izin).
                4.  **Saran (opsional):** Berikan satu saran singkat yang bisa dilakukan guru berdasarkan data ini.

                Format jawaban dalam HTML sederhana menggunakan heading (h4), paragraf (p), dan unordered list (ul/li).
            `;
            
            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "" // API Key tidak diperlukan jika menggunakan model flash
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    analysisResultElem.innerHTML = `
                        <h3 class="orbitron text-xl font-bold text-cyan-400 mb-4">‚ú® Analisis Laporan AI</h3>
                        <div class="text-gray-300 space-y-3">${text}</div>
                    `;
                } else {
                    throw new Error("Respons dari AI tidak valid atau kosong.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                analysisResultElem.innerHTML = `
                    <h3 class="orbitron text-xl font-bold text-red-400 mb-4">Gagal Menganalisis</h3>
                    <p class="text-gray-300">Terjadi kesalahan saat menghubungi layanan AI. Silakan coba lagi nanti.</p>
                    <p class="text-xs text-gray-500 mt-2">Detail error: ${error.message}</p>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            createParticles();
            updateCurrentDate();
            setInterval(updateCurrentDate, 60000);
        });
    </script>
</body>
</html>
